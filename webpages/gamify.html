<!DOCTYPE html>
<html>

<head>
	<title>Gamify</title>
	<link rel="stylesheet" type="text/css" id="gamify-css">
</head>

<body>
	<script>
		const styleSheet = `
  @font-face {
	font-family: 'comfortaa';
	src: url('${window.location.origin}/comfortaa-regular') format('ttf');
  }
`;

		const styleTag = document.createElement("style");
		styleTag.innerHTML = styleSheet;
		document.head.appendChild(styleTag);
	</script>

	<div class="background"></div>
	<div class="particles" id="particles"></div>
	<div class="scroll-container">
		<div class="category-container" id="categories"></div>
	</div>

	<script>
		document.getElementById('gamify-css').href = `${window.location.origin}/gamify-css`;

		const container = document.getElementById('particles');

		for (let i = 0; i < 50; i++) {
			const particle = document.createElement('div');
			particle.className = 'particle';

			const size = Math.random() * 8 + 6;
			particle.style.width = `${size}px`;
			particle.style.height = `${size}px`;
			particle.style.left = `${Math.random() * 100}vw`;
			particle.style.top = `${Math.random() * 100}vh`;
			particle.style.animationDuration = `${10 + Math.random() * 20}s`;

			container.appendChild(particle);
		}

		let data = [];

		// Get the data from the gamify-data endpoint
		const params = new URLSearchParams(window.location.search);
		const gParam = params.get('g') || '';
		data = fetch(`${window.location.origin}/gamify-data?g=${gParam}`)
			.then(response => response.json())
			.then(data => {
				// Create a new div for each category in the data array
				data.forEach(category => {
					const categoryDiv = document.createElement('div');
					categoryDiv.className = 'category';

					const categoryDivHeader = document.createElement('div');
					categoryDivHeader.className = 'category-header';
					categoryDivHeader.classList.add('expanded');

					categoryDiv.style.order = category.percentageDone.replace('%', '').replace('None', '100');

					categoryDivHeader.innerHTML = `
				<h3>${category.name} - ${category.percentageDone}</h3>
			`;

					categoryDiv.appendChild(categoryDivHeader);

					// Add a click event to collapse/expand the category
					categoryDivHeader.addEventListener('click', () => {
						categoryDivHeader.classList.toggle('collapsed');
						categoryDivHeader.classList.toggle('expanded');

						const tasks = categoryDiv.querySelectorAll('.task');
						tasks.forEach(task => {
							task.classList.toggle('hidden');
						});
					});

					// Create a new div for each task in the category
					category.tasks.forEach(task => {
						const taskDiv = document.createElement('div');
						taskDiv.className = 'task';

						if (task.done) {
							taskDiv.classList.add('done');
							taskDiv.style.order = 2;
						} else {
							taskDiv.style.order = 1;
						}

						taskDiv.innerHTML = `
					<p>${task.name}</p>
					`;

						// Add a click event to toggle the task's done status
						taskDiv.addEventListener('click', () => {
							task.done = !task.done;
							taskDiv.classList.toggle('done');
							taskDiv.style.order = task.done ? 2 : 1;

							// Update the task's done status in the data array
							const taskIndex = category.tasks.indexOf(task);
							if (taskIndex > -1) {
								category.tasks[taskIndex].done = task.done;
							}

							// Update the category's percentage done
							let totalTaskWeight = 0;
							let doneTaskWeight = 0;

							for (let i = 0; i < category.tasks.length; i++) {
								let task = category.tasks[i];

								let weight = 1;

								if(task.weight){
									weight = task.weight;
								}

								totalTaskWeight += weight;
								if (task.done) {
									doneTaskWeight += weight;
								}
							}

							category.percentageDone = `${Math.round((doneTaskWeight / totalTaskWeight) * 100)}%`;

							categoryDivHeader.innerHTML = `
						<h3>${category.name} - ${category.percentageDone}</h3>
					`;

							// Send the updated data to the server
							if (task.done) {
								fetch(`${window.location.origin}/gamify-done?g=${gParam}&t=${task.name}`);
							} else {
								fetch(`${window.location.origin}/gamify-open?g=${gParam}&t=${task.name}`);
							}
						});

						categoryDiv.appendChild(taskDiv);
					});

					// Append the category div to the container
					const categoriesContainer = document.getElementById('categories');
					categoriesContainer.appendChild(categoryDiv);
				});

				return data;
			})
			.catch(error => {
				console.error('Error fetching gamify data:', error);
			});
	</script>
</body>

</html>